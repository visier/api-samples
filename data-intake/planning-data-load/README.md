# Planning Data Load

## Overview
This is a sample python script that pulls data from a source file (in this example it is `source.csv`) and loads it into a specific plan and scenario using the set of [Visier Planning Data Load APIs](https://visier.mcoutput.com/1383909/apis/data-in/planning-data-load/planning-data-load-api.htm).

# Getting started

## Environment
Python 3.x installed on your system and have installed all dependencies:
- `pandas`
- `os`
- `visier_api_core`
- `visier-api-analytic-model`
- `visier-api-data-in`

You can install them using pip and the provided `requirements.txt`.

## Configuration
Configure the `.env` file.

The properties below are used for authentication. 
The `authenticate` function requests for a security token from Visier. 
You may modify this function if you wish to change the method of authentication.
See [Visier's authentication API](https://docs.visier.com/visier-people/apis/authentication/authentication.htm) for other options.
```
VISIER_HOST=https://customer-specific.ai.visier.io
VISIER_API='visier-provided-api-key'
VISIER_USERNAME='visier-username'
VISIER_PASSWORD='visier-password'
VISIER_VANITY='visier-tenant-vanity-name
```

The next set of properties relate to the plan and scenario you wish to modify and load data into.
The user must have edit access to the plan. If the user is not the owner of the plan, see [How to Share Your Plan](https://docs.visier.com/visier-people/Planning/plan%20sharing/plan%20sharing.htm).
```
PLAN_ID='plan-id'
SCENARIO_ID='scenario-id'
METHOD='loading-method'
CALCULATION='calculation-method'
```
The `METHOD` is one of the query parameters determining if the load if the data is persisted or not into the plan.
Below are the possible values for this property:
- `VALIDATE`: will not persist any of the changes. The response will tell you only how many potential cells will change or rows will be added or deleted.
- `SKIP_ERRORS`: will persist even if there are errors in the rows of the CSV, such as incorrect paths. It will fail if the CSV has formatting errors such as missing or duplicate columns.
- `STRICT_UPLOAD`: will not persist any changes if there has been errors found in the file. 

The `CALCULATION` method determines whether the loaded values roll up to the parent value, distribute among child values, or neither. Below are the possible values for the property:
- `ROLLUP`: Roll up children data values to parent data values. If the data provides a parent value and its child value, this method prioritizes the loaded value for the child and and overwrites the parent.
- `DISTRIBUTE`: Distribute parent data values to their children. If the value of the child conflicts with the calculated distribution, this method overrides the loaded child value.
- `NONE`: The loaded values are neither rolled up or distributed. This is the default.

The last set of configurations are the filenames for the source file and the CSVs that will be generated by the script for the load. 
You may not need to use `SOURCE_FILENAME` if you're not going to be loading data from a csv.
```
SOURCE_FILENAME='source-filename'
MAPPED_DATA_LOAD_FILENAME='mapped-source-file-data-load'
MAPPED_ADD_REMOVE_FILENAME='mapped-file-add-rows'
```

# Usage
This script uploads data from a source file into a plan. 
It first attempts a load using the `VALIDATE` method to identify any errors. This script only handles missing rows. 
You may wish to handle other errors in the script. You can modify `load_data_into_visier` to do so.
If rows in the source file are not present in the plan, it adds these rows to the plan and then finally loads the data.

The following functions of the script **must** be adapted before it can be used to load data into a plan:
- **`get_source_data`**
  - This function is hardcoded to look at the sample `source.csv`. 
  - This should be modified to fetch data from another application.
- **`map_data`**
  - This function's logic is based on the sample source data. You should change the logic in this function to match those of your source file.
  - This function has helper functions like `map_row_data`,`generate_time_lookup` that will also need to be changed.







